<?xml version="1.0" encoding="UTF-8"?>
<Module>

  <ModulePrefs
        title="map-gadget"
        height="410"
        scaling="false" />
  <Require feature="dynamic-height"/>
  <UserPref name="_table_query_url"
        display_name="Data source url"
        required="true"/>
  
  <UserPref name="_table_query_refresh_interval"
        display_name="Data refresh interval (minutes)"
    default_value="0"
        datatype="enum"
        required="false">
    <EnumValue value="0"
          display_value="Do not refresh"/>
    <EnumValue value="60"
          display_value="1"/>
    <EnumValue value="300"
          display_value="5"/>
    <EnumValue value="1800"
          display_value="30"/>
  </UserPref>

  <Content type="html">
  <![CDATA[
  <div id="map-canvas"></div>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=visualization"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      function initialize() {
        var query = new google.visualization.Query(prefs.getString('_table_query_url'), {sendMethod: 'auto'});
        query.setRefreshInterval(Number(prefs.getString('_table_query_refresh_interval')));
        query.send(handleQueryResponse);
      }
      
      function handleQueryResponse(response) {
        var data = response.getDataTable();
        
        var mapOptions = {
          zoom: 16,
          center: new google.maps.LatLng(data[2][1], data[2][2])
        };
        
        var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

        var layer = new google.maps.visualization.DynamicMapsEngineLayer({
          layerId: '11689989258151602055-16133476562581908850',
          map: map,
          suppressInfoWindows: false,
          clickable: true
        });
        
        var options = {
          enableScrollWheel: true,
          showTip: true,
          showLine: true,
          lineWidth: 5,
          mapType: 'normal',
          useMapTypeControl: true
          };
        
        map.draw(data, options);
        
        map.fitBounds(google.maps.LatLngBounds());
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  ]]>
  </Content>
</Module>