<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs
      title="Indicateurs Valeo"
      description="Gadget regroupant des indicateurs pour Valeo"
      author="XB-SOPRA"
      author_affiliation="Sopra"
      author_email="bob@gmail.com"
      height="550">
    <Require feature="idi" />
    <Require feature="locked-domain" />
    <Require feature="dynamic-height"/>
</ModulePrefs>
  <UserPref name="_table_query_refresh_interval" display_name="Data refresh interval (minutes)" default_value="60" datatype="enum" required="false">
    <EnumValue value="0" display_value="Do not refresh"/>
    <EnumValue value="60" display_value="1"/>
    <EnumValue value="300" display_value="5"/>
    <EnumValue value="1800" display_value="30"/>
  </UserPref>
  <UserPref name="disableHtml" display_name="Disable Html" datatype="bool" default_value="false"/>
  <Content type="html" view="home,canvas">
<![CDATA[
<html>
  <head>
    <script type='text/javascript' src='http://www.google.com/jsapi'></script>
    <script type='text/javascript' src='http://dl.getdropbox.com/u/168571/Gadgets/myvisujs.js'></script>
    <script type='text/javascript'>
      google.load('visualization', '1', {packages:['linechart','gauge']});
      var table = null, data=null, gadgetHelper = null,msg = null ;
      var options=null, options2=null, options3=null;
      var marge = 2 ;
      
      var prefs = new gadgets.Prefs();
      google.setOnLoadCallback(sQBarChart);
      google.setOnLoadCallback(sQGauge);
      google.setOnLoadCallback(mytabdata);
      
      window.onresize = function(event) {
        if((options.width + marge) < document.body.clientWidth || ( document.body.clientWidth < options.width - marge))
        {
            options.width = document.body.clientWidth ;
            options.height = document.body.clientWidth/1.33 ; 
            table.draw(data, options);
            gadgets.window.adjustHeight(options.height + options2.height + options3.height+20) ;
        }
      }
      
    function sQBarChart() {
        var prefs = new gadgets.Prefs();
        var tableDiv = document.getElementById('chart_div'); 
        //tableDiv.style.width = document.body.clientWidth/2 + 'px';
        //tableDiv.style.height = document.body.clientWidth/1.33 + 'px';
        table = new google.visualization.LineChart(tableDiv);
        query = new google.visualization.Query('http://spreadsheets.google.com/tq?key=0AmcHW_qcbru0dHJkT3FTX2h4blJPRGRJWjROT1ZNLUE&range=A1:C25&gid=1&headers=1');
        var val = prefs.getInt("_table_query_refresh_interval");
        query.setRefreshInterval(val);
        query.send(hQRBarChart);
    }
    
    function hQRBarChart(response) {
        if (response.isError()) {
            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
            return;
        }
        
        data = response.getDataTable();
        options = {legend: 'bottom', title: 'DÃ©ploiements'} ;
        options.width = document.body.clientWidth ;
        options.height = document.body.clientWidth/1.33 ; 
        table.draw(data, options);
    }
      
    function sQGauge() {
        var query = new google.visualization.Query('https://spreadsheets.google.com/tq?key=0AmcHW_qcbru0dHJkT3FTX2h4blJPRGRJWjROT1ZNLUE&range=A1:B3&gid=0&headers=1');
        var val = prefs.getInt("_table_query_refresh_interval");
        query.setRefreshInterval(val);
        query.send(hQRGauge);
    }

    function hQRGauge(response) {
        if (response.isError()) {
            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
            return;
        }
        var tableDivC = document.getElementById('chart_div2');
        tableDivC.style.width = 300 + 'px';
        var dataC = response.getDataTable();
        var chartC = new google.visualization.Gauge(tableDivC);
        options2 = {width: 300, height: 150, redFrom: 90, redTo: 100, yellowFrom:75, yellowTo: 90, minorTicks: 5};
        chartC.draw(dataC, options2);
    }
    
    function mytabdata() {
        var query = new google.visualization.Query('https://spreadsheets.google.com/tq?key=0AmcHW_qcbru0dHJkT3FTX2h4blJPRGRJWjROT1ZNLUE&range=A1:A2&gid=2&headers=1');
        var val = prefs.getInt("_table_query_refresh_interval");
        query.setRefreshInterval(7);
        query.send(mytab);
    }
    
    function mytab(response)
    {
        if (response.isError()) {
            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
            return;
        }
        var div3 = document.getElementById('chart_div3');
        var data3 = response.getDataTable();
        var vis = new valeo.MyTable(div3);
        options3 = {width: 22, height: 22};
        vis.draw(data3,options3);
    }
    </script>
  </head>
  <body>
    <div id='chart_div'></div>
    <div id='chart_div2' style="margin-left: auto; margin-right: auto;"></div>
    <div id='chart_div3' style="margin-left: auto; margin-right: auto; width: 150;"></div>
  </body>
</html>
]]>
  </Content>
</Module>